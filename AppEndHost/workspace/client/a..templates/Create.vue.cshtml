@using AppEndServer
@using AppEndDbIO
@using AppEndCommon
@using System.Linq.Expressions
@using Newtonsoft
@using Newtonsoft.Json
@using RazorEngine.Text
@{
	string submitRPC = Model.ClientUI.SubmitAPI;

	var createColumns = Model.GetCreateColumns();

	List<string> groups = Model.DbDialog.GetGroups(submitRPC);

	List<DbQueryColumn> humanIdCols = Model.GetColumnsHumanIdsForForm(submitRPC);
	List<DbQueryColumn> imageCols = Model.GetColumnsImageForForm(submitRPC);
	List<DbQueryColumn> normalCols = Model.GetColumnsNormalForForm(submitRPC);
	
	var relationsManyToMany = Model.DbDialog.GetRelations(submitRPC, RelationType.ManyToMany);
	var relationsOneToManyFileCentric = Model.DbDialog.GetRelations(submitRPC, RelationType.OneToMany, true);
	var relationsOneToManyNormal = Model.DbDialog.GetRelations(submitRPC, RelationType.OneToMany, false);

}
<template>
<div class="card h-100 bg-transparent rounded-0 border-0">
		<div class="card-body bg-dark-subtle bg-opacity-75 scrollable">


					<div class="row">

						@if (imageCols.Count > 0)
						{
							<div class="card rounded-1 border-light mb-1">
								<div class="card-body">
									<div class="col-48">
										<div class="row">
											<div class="col"></div>
											@foreach (DbQueryColumn col in imageCols)
											{
												<div class="col-12">
													@(new RawString(Model.CompileTemplate("FormColumnContent", col.Name)))
												</div>
											}
											<div class="col"></div>
										</div>
									</div>
								</div>
							</div>
						}

						@if (humanIdCols.Count > 0)
						{
							<div class="card rounded-1 border-light mb-1">
								<div class="card-body">
									<div class="row">
										@foreach (DbQueryColumn col in humanIdCols)
										{
											<div class="col-48" v-if="inputs.fkColumn!=='@col.Name'">
												@(new RawString(Model.CompileTemplate("FormColumnContent", col.Name)))
											</div>
										}
									</div>
								</div>
							</div>
						}

						@if (normalCols.Count > 0)
						{
							<div class="card rounded-1 border-light mb-1">
								<div class="card-body">
									<div class="row">
										@foreach (DbQueryColumn col in normalCols)
										{
											<div class="col-48" v-if="inputs.fkColumn!=='@col.Name'">
												@(new RawString(Model.CompileTemplate("FormColumnContent", col.Name)))
											</div>
										}
									</div>
								</div>
							</div>
						}

						@foreach (string g in groups)
						{
							<div class="card rounded-1 border-light mb-1">
								<div class="card-header text-bg-light">
									{{shared.translate('@g')}}
								</div>
								<div class="card-body">
									<div class="row">
										@foreach (DbQueryColumn col in Model.GetColumnsByGroupNameForForm(g))
										{
											<div class="col-48">
												@(new RawString(Model.CompileTemplate("FormColumnContent", col.Name)))
											</div>
										}
									</div>
								</div>
							</div>
						}

						@foreach (var rel in relationsManyToMany)
						{
							<div class="col-48">
								@if (rel.RelationUiWidget.ToString() == "CheckboxList")
								{
									@(new RawString(Model.CompileTemplate("FormRelationCheckboxList", rel.RelationName)))
								}
								@if (rel.RelationUiWidget.ToString() == "AddableList")
								{
									@(new RawString(Model.CompileTemplate("FormRelationAddable", rel.RelationName)))
								}
							</div>
						}

						@foreach (var rel in relationsOneToManyFileCentric)
						{
							<div class="col-48">
								@(new RawString(Model.CompileTemplate("FormRelationFiles", rel.RelationName)))
							</div>
						}

						@foreach (var rel in relationsOneToManyNormal)
						{
							<div class="col-48">
								@(new RawString(Model.CompileTemplate("FormRelationNormal", rel.RelationName)))
							</div>
						}

					</div>



		</div>
		<div class="card-footer p-3 bg-secondary-subtle bg-gradient border-0 rounded-0">
			<div class="row">
				<div class="col-12">
					<button class="btn btn-sm btn-secondary w-100 py-2" @click="cancel" data-ae-key="ok">
						<i class="fa-solid fa-cancel pe-1"></i> <span>{{shared.translate("Cancel")}}</span>
					</button>
				</div>
				<div class="col-36">
					<button class="btn btn-sm btn-primary w-100 py-2" @click="ok" data-ae-key="ok">
						<i class="fa-solid fa-check pe-1"></i> <span>{{shared.translate("Ok")}}</span>
					</button>
				</div>
			</div>
		</div>
	</div>
</template>

<script>
	let _this = { cid: "", c: null, inputs: {}, dbConfName: "", objectName: "", submitMethod: "", initialRequests: [], initialResponses: [], pickerRequests: [], pickerHumanIds: [], row: {}, Relations: {}, RelationsMetaData: {}, regulator: null };
	_this.dbConfName = "@Model.DbDialog.DbConfName";
	_this.objectName = "@Model.DbDialog.ObjectName";
	_this.submitMethod = "@submitRPC";

	@(new RawString("_this.row = " + Model.GetCreateRpcBody() + ";"))

	@foreach (var relO in relationsManyToMany)
	{
		@(new RawString("\n\r_this.Relations['" + relO.RelationTable + "']=[];"))
		@(new RawString("\n\r_this.RelationsMetaData['" + relO.RelationName + "']=" + relO.ToJsonStringByBuiltIn(false) + ";"))
		@(new RawString("\n\r_this.initialRequests.push(" + Model.GetApiBodyForLinkingColumn(relO.RelationName).ToJsonStringByBuiltIn(false) + ");"))
	}

	@foreach (var relO in relationsOneToManyFileCentric)
	{
		@(new RawString("\n\r_this.Relations['" + relO.RelationTable + "']=[];"))
		@(new RawString("\n\r_this.RelationsMetaData['" + relO.RelationName + "']=" + relO.ToJsonStringByBuiltIn(false) + ";"))
	}

	@foreach (var relO in relationsOneToManyNormal)
	{
		@(new RawString("\n\r_this.Relations['" + relO.RelationTable + "']=[];"))
		@(new RawString("\n\r_this.RelationsMetaData['" + relO.RelationName + "']=" + relO.ToJsonStringByBuiltIn(false) + ";"))
		@(new RawString("\n\r_this.RelationsMetaData['" + relO.RelationName + "']['createComponent']='" + "/a.DbComponents/" + Model.DbDialog.DbConfName + "_" + relO.RelationTable + "_Create" + "';"))
		@(new RawString("\n\r_this.RelationsMetaData['" + relO.RelationName + "']['updateComponent']='" + "/a.DbComponents/" + Model.DbDialog.DbConfName + "_" + relO.RelationTable + "_UpdateByKey" + "';"))
	}


	@foreach (var col in createColumns)
	{
		var dbCol = Model.DbDialog.GetColumn(col.Name);
		string uiWidget = (dbCol.UiProps != null && dbCol.UiProps.UiWidget != null) ? dbCol.UiProps.UiWidget.ToString().ToLower() : "";
		string collectionName = (uiWidget == "combo" || uiWidget == "radio") ? "initialRequests" : "pickerRequests";

		if (dbCol.Fk is not null && dbCol.Fk.Lookup is not null)
		{
			var lookUp = dbCol.Fk.Lookup;
			lookUp.Id = dbCol.Name + "_Lookup";
			@(new RawString("_this." + collectionName + ".push(" + lookUp.ToJsonStringByBuiltIn(false) + ");"))
			if (collectionName == "pickerRequests")
			{
				@(new RawString("\n\r_this.pickerHumanIds.push({Id:'" + col.Name + "_HumanIds',Items:" + Model.GetTargetHumanIdsFor(dbCol).ToJsonStringByBuiltIn(false) + "});"))
			}
		}
	}

	export default {
		methods: {
			localSelectFiles(relName, parentId, fieldName_FileContent, fieldName_FileName, fieldName_FileSize, fieldName_FileType) {
				crudSelectFiles(_this, relName, parentId, fieldName_FileContent, fieldName_FileName, fieldName_FileSize, fieldName_FileType);
			},
			localAddRelation(relName) { crudAddRelation(_this, relName); },
			localRemoveRelation(relName, ind) { crudRemoveRelation(_this, relName, ind); },
			localOpenPicker(colName) { crudOpenPicker(_this, _this.c.row, colName); },
			localCrudUpdateRelation(compPath, modalSize, recordKey, ind,fkColumn,relName) { crudUpdateRelation(_this, compPath, modalSize, recordKey, ind,fkColumn,relName); },
			localCrudBaseInfo() { crudLoadBaseInfo(_this); },
			ok() {
				if (!_this.regulator.isValid()) return;
				if (_this.c.inputs.okAction === 'return') {
					if (_this.inputs.callback) _this.inputs.callback(_this.row);
					_this.c.close();
				} else {
					crudSaveRecord(_this, function () {
						if (_this.inputs.callback) _this.inputs.callback();
						_this.c.close();
					});
				}
			},
			cancel() { _this.c.close(); },
			close() { shared.closeComponent(_this.cid); }
		},
		setup(props) { 
			_this.cid = props['cid'];
			_this.inputs = shared["params_" + _this.cid];
		},
		data() { return _this; },
		created() { _this.c = this; },
		mounted() { initVueComponent(_this); _this.c.localCrudBaseInfo(); },
		props: { cid: String }
	}
</script>
